<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv= "Cache-Control" content= "no-cache" /> 
    <meta http-equiv= "Expires" content= "0" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta content="tele
    phone=no" name="format-detection" />
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <link rel="stylesheet" type="text/css" href="styles/css/style.css"/>
    <script src="./scripts/zepto.min.js"></script>
    <script src="./scripts/config.js"></script>
    <title>我的订单</title>       
</head>
<body>
    <div id="page-ptr" class="page">
        <header class="bar bar-nav">
            <h1 class="title">我的订单</h1>
        </header>
        <input type="hidden" id="lat">
        <input type="hidden" id="lng">
        <input type="hidden" class="userId">
        
        <div class="content infinite-scroll infinite-scroll-bottom pull-to-refresh-content" data-distance="100" data-ptr-distance="55">
            <div class="pull-to-refresh-layer">
                <div class="preloader"></div>
                <div class="pull-to-refresh-arrow"></div>
            </div>
            <ul class="order-list"></ul>
            
            <!-- 加载提示符 -->
            <div class="infinite-scroll-preloader">
              <div class="preloader"></div>
            </div>
            <div class="nav-blank"></div>
        </div>
        <!-- 工具栏 -->
        <nav class="bar bar-tab">
            <a class="tab-item external" href="index.html">
                <span class="icon icon-index"></span>
                <span class="tab-label">抢单</span>
            </a>
            <a class="tab-item external active" href="myOrderList.html">
                <span class="icon icon-order"></span>
                <span class="tab-label">航程</span>
            </a>
            <a class="tab-item external" href="userInfo.html">
                <span class="icon icon-my"></span>
                <span class="tab-label">我的</span>
            </a>
        </nav>>
    </div>
    <script type="text/html" id="listTempl">
        {{each data as list i}}
            <li>
                <div class="o-title o-title2">
                    <div class="name">{{list.goodsName}}{{list.dispatchWeight}}吨</div>
                    <div class="state"><span>{{list.statusName}}</span><i class="arrow"></i></div>
                </div>
                <div class="info-box">
                    <div class="time"><i class="icon-time"></i><span>装货时间：{{list.dischargeTime}}</span></div>
                    <div class="info"><i class="icon-start"></i><span>装货码头：{{list.startPortName}}</span></div>
                    <div class="info"><i class="icon-end"></i><span>卸货码头：{{list.endPortName}}</span></div>
                </div>
                
                <div class="btn-box border-thin">
                    <p class="tip">注：{{list.specialTip}}</p>
                    {{if list.statusName == "已预约"}}
                    <div class="btn border-thin J_cancel" reserveId="{{list.id}}">取消预约</div>
                    {{/if}}
                </div>
            </li>
        {{/each}}
    </script>
    <script>
        var myOrderUrl = $.config.appUrl + 'xyl/reservation/getMyOrder',
            cancelUrl = $.config.appUrl + 'xyl/reservation/modify';//取消预约接口
    </script>
    <script type="text/javascript">
    lazyLoad.require(['https://g.alicdn.com/msui/sm/0.6.2/js/sm.min.js','./scripts/common.js'],function(sm,boatIndex){
        if(boatIndex.isAndroid && boatIndex.isXYWL && XYNativeClient){
            window.doBack = function(){
                try{
                    XYNativeClient.doFinish();
                }
                catch(e){
                    alert(e);
                }
            }
        }
        var params = {
            url: myOrderUrl,
            data:{},
            parent:$('.order-list'),
            templateId:'listTempl',
            success:function(json, ajaxOptions, elements){
                $(elements).each(function(index,element){
                    //var statusName = $(this).attr('statusName'),
                        //btn = $(element).find('.btn'),
                        //reserveId = btn.attr('reserveId');
                    var btnCancel = $(element).find('.J_cancel');//取消预约
                    //if(statusName == '已预约'){
                        btnCancel.bind('click',function(){
                            var reserveId = $(this).attr('reserveId');
                            boatIndex.commonAjax({
                                url: cancelUrl,
                                data: {
                                    id: reserveId
                                },
                                success:function(data,elements,parent){
                                    if(data.success){
                                        boatIndex.toast('订单已关闭');
                                        setTimeout(function(){
                                            location.reload();
                                        },1000);
                                    }
                                    else{
                                        if(data.msg)boatIndex.toast(data.msg);
                                    }
                                },
                                error:function(data){
                                    boatIndex.toast('网络连接失败，请稍后重试...');

                                }
                                
                            });
                        });
                        $(element).find('.info-box').bind('click',function(){
                            window.location.href = 'appointSuccess.html?id=' + reserveId ;
                        });
                    //}
                });
            },
            zero:function(parent){
                var html = '<div class="error-box"><div class="icon">i</div><div class="msg">暂无数据</div></div>';
                parent.html(html);
            }
        };
        boatIndex.infinitScroll(params);
        $(document).on('refresh', '.pull-to-refresh-content',function(e) {
            // 模拟1s的加载过程
            setTimeout(function() {
                if($('.error-box').length > 0){
                    boatIndex.infinitScroll(params);
                }
                // 加载完毕需要重置
                $.pullToRefreshDone('.pull-to-refresh-content');
            }, 1000);
        });
        $.init();
    });
    </script>
</body>
</html>